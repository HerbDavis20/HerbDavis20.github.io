<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>WHS Handicap Calculator — 9 & 18 Holes (Immediate 9→18 Conversion)</title>
<style>
  :root{
    --bg: #f8fafc; --panel:#fff; --text:#0f172a; --muted:#475569; --muted2:#64748b; --border:#e2e8f0; --accent:#2563eb; --accent2:#1d4ed8; --shadow:0 10px 20px rgba(2,6,23,.06); --r:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,var(--bg),#fff); color:var(--text); font-size:16px;-webkit-font-smoothing:antialiased}
  .container{max-width:1120px;margin:0 auto;padding:24px;padding-left:max(24px,env(safe-area-inset-left));padding-right:max(24px,env(safe-area-inset-right))}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap}
  h1{margin:0;font-size:clamp(22px,3.6vw,28px);letter-spacing:-.01em}
  .hint{color:var(--muted);font-size:14px}
  .grid{display:grid;gap:20px}
  @media(min-width:900px){.grid{grid-template-columns:1.6fr 1fr}}
  .inputs{order:2} .results{order:1} @media(min-width:900px){.inputs{order:1}.results{order:2}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow)}
  .content{padding:20px}
  label{display:block;color:var(--muted);font-size:14px;margin-bottom:6px}
  input,select{width:100%;padding:14px;border:1px solid var(--border);border-radius:12px;min-height:44px;font-size:18px;background:#fff}
  input:focus,select:focus{outline:2px solid rgba(37,99,235,.35);outline-offset:2px}
  .row{display:grid;gap:12px}
  .row.c2{grid-template-columns:1fr 1fr}
  .row.c3{grid-template-columns:1fr 1fr 1fr}
  @media(max-width:520px){.row.c2,.row.c3{grid-template-columns:1fr}}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  button{appearance:none;border:0;border-radius:999px;padding:12px 18px;min-height:44px;background:var(--accent);color:#fff;font-weight:700;font-size:16px;cursor:pointer}
  button:hover{background:var(--accent2)}
  button.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
  .result{border:1px solid var(--border);border-radius:16px;padding:16px}
  .label{color:var(--muted);font-size:14px}
  .value{font-size:32px;font-weight:800;letter-spacing:-.02em}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{text-align:left;padding:12px}
  thead th{color:var(--muted);border-bottom:1px solid var(--border)}
  tbody tr{border-bottom:1px solid var(--border)}
  .muted{color:var(--muted2)}
  details{border:1px solid var(--border);border-radius:12px;padding:12px}
  summary{cursor:pointer;font-weight:600}
  .cta-fixed{position:fixed;left:0;right:0;bottom:0;padding:10px 16px calc(10px + env(safe-area-inset-bottom));background:rgba(255,255,255,.96);backdrop-filter:saturate(180%) blur(10px);border-top:1px solid var(--border);display:flex;gap:10px;justify-content:center}
  .cta-fixed .btn{flex:1;max-width:520px}
  @media(min-width:900px){.cta-fixed{display:none}}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>WHS Handicap Calculator (UK) — Immediate 9→18 conversion</h1>
      <div class="hint">9‑hole scores now convert immediately to a full 18‑hole differential using your current HI.</div>
    </header>

    <div class="grid">
      <div class="card results">
        <div class="content">
          <h2 style="margin:0 0 10px 0;font-size:18px">Results</h2>
          <div class="result">
            <div class="label">Score Differential (<span id="sdBasis">18</span>-hole basis)</div>
            <div class="value" id="sdValue">–</div>
            <div class="muted" id="sdNote" style="font-size:13px;margin-top:6px;display:none"></div>
          </div>
          <div class="result" style="margin-top:12px">
            <div class="label"><span id="sd18Title">18-hole Score Differential</span></div>
            <div class="value" id="sd18Value">–</div>
            <div class="muted" id="sd18Note" style="font-size:12px;margin-top:6px"></div>
          </div>
          <div class="result" style="margin-top:12px;background:#f8fafc">
            <div class="label">Estimated Handicap Index from history</div>
            <div class="value" id="hiFromHistory">–</div>
            <div class="muted" style="font-size:12px;margin-top:6px">Best 8 of last 20 differentials (single‑file estimator).</div>
          </div>
        </div>
      </div>

      <div class="card inputs">
        <div class="content">
          <div class="row c2">
            <div>
              <label for="holes">Holes</label>
              <select id="holes">
                <option value="18">18 holes</option>
                <option value="9">9 holes</option>
              </select>
            </div>
            <div>
              <label for="ags">Adjusted Gross Score (<span id="holesLabel">18</span>-hole)</label>
              <input id="ags" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="e.g. 88" />
            </div>
          </div>

          <div class="row c3" style="margin-top:12px">
            <div>
              <label for="cr">Course Rating (<span id="holesLabel2">18</span>-hole)</label>
              <input id="cr" type="text" inputmode="decimal" placeholder="e.g. 71.2" />
            </div>
            <div>
              <label for="slope">Slope Rating (<span id="holesLabel3">18</span>-hole)</label>
              <input id="slope" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="e.g. 125" />
            </div>
            <div>
              <label for="par">Par (optional)</label>
              <input id="par" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="e.g. 72" />
            </div>
          </div>

          <div class="row c2" style="margin-top:12px">
            <div>
              <label for="pcc">Playing Conditions (PCC)</label>
              <select id="pcc">
                <option value="-1">-1</option>
                <option value="0" selected>0</option>
                <option value="1">+1</option>
                <option value="2">+2</option>
                <option value="3">+3</option>
              </select>
            </div>
            <div id="hiWrap" style="display:none">
              <label for="hi">Current Handicap Index (required for 9‑hole)</label>
              <input id="hi" type="text" inputmode="decimal" placeholder="e.g. 14.3" />
            </div>
          </div>

          <div style="margin-top:12px">
            <label for="notes">Notes (course/tees, competition, etc.)</label>
            <input id="notes" placeholder="e.g. St Andrews Old, yellow tees" />
          </div>

          <details style="margin-top:12px">
            <summary>Advanced: expected 9‑hole component</summary>
            <div class="muted" style="font-size:14px;margin:8px 0 10px">For 9‑hole entries we add an expected 9‑hole differential derived from your HI so the total is a full 18‑hole SD. Default: <code>expected = factor × HI</code> with factor = 0.50. You can tweak the factor here if needed.</div>
            <div class="row c2">
              <div>
                <label for="expFactor">Factor (expected = factor × HI)</label>
                <input id="expFactor" type="text" inputmode="decimal" value="0.50" />
              </div>
              <div>
                <label for="previewExpected">Preview expected 9‑hole from HI</label>
                <input id="previewExpected" disabled placeholder="–" />
              </div>
            </div>
          </details>

          <div class="actions" style="margin-top:16px">
            <button id="addRound" disabled>Add to history</button>
            <button class="ghost" id="clearInputs">Clear inputs</button>
          </div>
        </div>
      </div>
    </div>

    <section style="margin-top:24px" class="card">
      <div class="content">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <h2 style="margin:0;font-size:18px">Round history</h2>
          <div class="muted" style="font-size:13px">HI = average of best 8 of last 20 18‑hole differentials</div>
        </div>
        <div id="historyEmpty" class="muted" style="margin-top:10px">No rounds yet. Add a round to build your history.</div>
        <div id="historyWrap" style="display:none;overflow:auto;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Holes</th>
                <th>AGS</th>
                <th>CR</th>
                <th>Slope</th>
                <th>PCC</th>
                <th>18‑hole SD</th>
                <th>Notes</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
          <div class="actions" style="margin-top:10px">
            <button class="ghost" id="clearHistory">Clear history</button>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <p class="muted">Disclaimer: This tool is for guidance only. National associations apply the WHS calculation officially. The expected 9‑hole component uses <em>factor × HI</em> (default 0.50); adjust in Advanced if your association publishes a different factor.</p>
    </footer>
  </div>

  <div class="cta-fixed">
    <button id="addRound2" class="btn">Add to history</button>
    <button id="clearInputs2" class="btn ghost">Clear</button>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const r1 = (x) => Math.round(x*10)/10;
  const toNum = (v) => { if(v===''||v==null) return NaN; const n = Number(v); return Number.isFinite(n)?n:NaN; };

  // Core formulas
  function calc18SD(ags, cr, slope, pcc){ return ((ags - cr - pcc) * 113) / slope; }
  function calc9SD(ags9, cr9, slope9, pcc){ return (113 / slope9) * (ags9 - cr9 - 0.5 * pcc); }
  function expected9_fromHI(hi, factor){ return factor * hi; }

  // HI from list of 18-hole differentials
  function hiFromSDs(sds){
    const last20 = sds.slice(-20);
    if (!last20.length) return NaN;
    if (last20.length < 8) return last20.reduce((a,b)=>a+b,0)/last20.length;
    const best8 = [...last20].sort((a,b)=>a-b).slice(0,8);
    return best8.reduce((a,b)=>a+b,0)/8;
  }

  const STORAGE_KEY = 'whs-calculator-rounds-v3';
  function loadRounds(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):[]; }catch(e){ return []; }}
  function saveRounds(arr){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }catch(e){} }

  // Elements
  const holesEl=$('holes'), agsEl=$('ags'), crEl=$('cr'), slopeEl=$('slope'), parEl=$('par'), pccEl=$('pcc'), hiEl=$('hi'), notesEl=$('notes');
  const sdValue=$('sdValue'), sdNote=$('sdNote'), sdBasis=$('sdBasis'), sd18Value=$('sd18Value'), sd18Title=$('sd18Title'), sd18Note=$('sd18Note');
  const addRoundBtn=$('addRound'), clearInputsBtn=$('clearInputs'), addRoundBtn2=$('addRound2'), clearInputsBtn2=$('clearInputs2');
  const historyWrap=$('historyWrap'), historyEmpty=$('historyEmpty'), historyBody=$('historyBody'), clearHistoryBtn=$('clearHistory'), hiFromHistory=$('hiFromHistory');
  const hiWrap=$('hiWrap'), holesLabel=$('holesLabel'), holesLabel2=$('holesLabel2'), holesLabel3=$('holesLabel3');
  const expFactorEl=$('expFactor'), previewExpectedEl=$('previewExpected');

  let rounds = loadRounds();

  function formatSD(x){ return Number.isFinite(x) ? r1(x).toFixed(1) : '–'; }

  function refreshHistory(){
    if(!rounds.length){ historyWrap.style.display='none'; historyEmpty.style.display='block'; hiFromHistory.textContent='–'; return; }
    historyWrap.style.display='block'; historyEmpty.style.display='none';
    historyBody.innerHTML='';
    const sds=[];
    for (const r of rounds){ if(Number.isFinite(r.sd18)) sds.push(r.sd18); }
    for (const r of rounds){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.date}</td>
        <td>${r.holes}</td>
        <td>${r.ags}</td>
        <td>${r.cr}</td>
        <td>${r.slope}</td>
        <td>${r.pcc}</td>
        <td><strong>${formatSD(r.sd18)}</strong></td>
        <td title="${r.notes||''}">${r.notes||''}</td>
        <td><button class="ghost" data-id="${r.id}">Delete</button></td>`;
      historyBody.appendChild(tr);
    }
    hiFromHistory.textContent = formatSD(hiFromSDs(sds));
  }

  function hiFromSDs(sds){ return formatNumber( hiFromSDsRaw(sds) ); }
  function hiFromSDsRaw(sds){
    const last20 = sds.slice(-20);
    if (!last20.length) return NaN;
    if (last20.length < 8) return last20.reduce((a,b)=>a+b,0)/last20.length;
    const best8 = [...last20].sort((a,b)=>a-b).slice(0,8);
    return best8.reduce((a,b)=>a+b,0)/8;
  }
  function formatNumber(x){ return Number.isFinite(x) ? r1(x) : NaN; }

  function recalc(){
    const holes = Number(holesEl.value);
    holesLabel.textContent=holes; holesLabel2.textContent=holes; holesLabel3.textContent=holes; sdBasis.textContent=holes;
    hiWrap.style.display = holes===9 ? 'block' : 'none';

    const ags = toNum(agsEl.value), cr = toNum(crEl.value), slope = toNum(slopeEl.value), pcc = toNum(pccEl.value), hi = toNum(hiEl.value);
    const factor = toNum(expFactorEl.value); if(Number.isFinite(hi) && Number.isFinite(factor)) previewExpectedEl.value = r1(expected9_fromHI(hi,factor)).toFixed(1); else previewExpectedEl.value='–';

    let sdBase = NaN, sd18Show = NaN;
    if (Number.isFinite(ags) && Number.isFinite(cr) && Number.isFinite(slope) && Number.isFinite(pcc)){
      if (holes===18){
        sdBase = calc18SD(ags,cr,slope,pcc);
        sd18Show = sdBase;
        sd18Title.textContent='18-hole Score Differential'; sd18Note.textContent=''; sdNote.style.display='none';
      } else {
        if (!Number.isFinite(hi)) { sdNote.style.display='block'; sdNote.textContent='Enter your current HI to convert a 9‑hole score to a full 18‑hole SD.'; }
        const sd9 = calc9SD(ags,cr,slope,pcc);
        sdBase = sd9;
        if (Number.isFinite(hi) && Number.isFinite(factor)){
          const expected9 = expected9_fromHI(hi,factor);
          sd18Show = sd9 + expected9;
          sd18Title.textContent='18-hole Score Differential (from 9 — WHS immediate)';
          sd18Note.textContent='Computed as 9‑hole SD + expected 9‑hole component from current HI.';
          sdNote.style.display='block';
          sdNote.textContent='9‑hole SD = (113 / slope) × (AGS − CR − 0.5×PCC)';
        } else {
          sd18Title.textContent='18-hole Score Differential (needs HI)';
          sd18Note.textContent='Provide your current HI to complete the conversion.';
          sdNote.style.display='block';
          sdNote.textContent='9‑hole SD = (113 / slope) × (AGS − CR − 0.5×PCC)';
        }
      }
    }

    sdValue.textContent = Number.isFinite(sdBase)? r1(sdBase).toFixed(1) : '–';
    sd18Value.textContent = Number.isFinite(sd18Show)? r1(sd18Show).toFixed(1) : '–';

    // Enable/disable Add buttons: require all base inputs; for 9 holes also require HI to store immediate 18 SD
    const baseReady = Number.isFinite(ags)&&Number.isFinite(cr)&&Number.isFinite(slope)&&Number.isFinite(pcc);
    const ok = holes===18 ? baseReady : (baseReady && Number.isFinite(hi) && Number.isFinite(toNum(expFactorEl.value)));
    addRoundBtn.disabled = !ok; if(addRoundBtn2) addRoundBtn2.disabled = !ok;
  }

  function addRound(){
    const holes = Number(holesEl.value);
    const ags = toNum(agsEl.value), cr = toNum(crEl.value), slope = toNum(slopeEl.value), pcc = toNum(pccEl.value), hi = toNum(hiEl.value);
    const factor = toNum(expFactorEl.value);
    const notes = (notesEl.value||'').trim();

    let sd18 = NaN;
    if (holes===18){
      sd18 = calc18SD(ags,cr,slope,pcc);
    } else {
      const sd9 = calc9SD(ags,cr,slope,pcc);
      const expected9 = expected9_fromHI(hi,factor);
      sd18 = sd9 + expected9; // immediate conversion
    }

    const id = (crypto&&crypto.randomUUID)? crypto.randomUUID() : String(Date.now()+Math.random());
    const date = new Date().toISOString().slice(0,10);
    rounds.push({id,date,holes,ags,cr,slope,pcc,sd18,notes});
    saveRounds(rounds);

    agsEl.value=''; crEl.value=''; slopeEl.value=''; parEl.value=''; notesEl.value=''; // keep PCC/HI
    recalc(); refreshHistory();
    try{ document.activeElement && document.activeElement.blur(); }catch(e){}
  }

  function clearInputs(){ agsEl.value=''; crEl.value=''; slopeEl.value=''; parEl.value=''; notesEl.value=''; recalc(); }
  function clearHistory(){ if(!rounds.length) return; if(!confirm('Clear all saved rounds?')) return; rounds=[]; saveRounds(rounds); refreshHistory(); }

  document.addEventListener('click', (e)=>{ const el=e.target; if(el&&el.matches('button[data-id]')){ const id=el.getAttribute('data-id'); rounds=rounds.filter(r=>r.id!==id); saveRounds(rounds); refreshHistory(); }});

  [holesEl,agsEl,crEl,slopeEl,pccEl,hiEl,expFactorEl].forEach(el=> el.addEventListener('input', recalc));
  addRoundBtn.addEventListener('click', addRound); clearInputsBtn.addEventListener('click', clearInputs); if(addRoundBtn2) addRoundBtn2.addEventListener('click', addRound); if(clearInputsBtn2) clearInputsBtn2.addEventListener('click', clearInputs); clearHistoryBtn.addEventListener('click', clearHistory);

  // init
  recalc(); refreshHistory();
})();
</script>
</body>
</html>
